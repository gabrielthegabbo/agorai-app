// Agorai: AI-powered Hiring Automation Platform
// Database Schema - Complete Definition

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT DOMAIN
// ============================================

enum UserRole {
  JOB_SEEKER
  RECRUITER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  username  String?    @unique
  password  String
  role      UserRole   @default(JOB_SEEKER)
  status    UserStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  account         Account?
  personalInfo    PersonalInfo?
  contact         Contact?
  resumes         Resume[]
  jobApplications JobApplication[]
  interviews      Interview[]
  responses       Response[]

  // For recruiters
  postedJobs      Job[]
  teamMemberships Team[]

  @@map("users")
}

enum AccountType {
  EMAIL
  GOOGLE
  GITHUB
  LINKEDIN
}

model Account {
  id                String      @id @default(uuid())
  userId            String      @unique
  accountType       AccountType @default(EMAIL)
  provider          String? // oauth provider
  providerAccountId String? // oauth provider account id
  refreshToken      String?     @db.Text
  accessToken       String?     @db.Text
  expiresAt         DateTime?
  tokenType         String?
  scope             String?
  idToken           String?     @db.Text
  sessionState      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model PersonalInfo {
  id            String    @id @default(uuid())
  userId        String    @unique
  firstName     String
  lastName      String
  birthDate     DateTime?
  gender        String?
  city          String?
  stateProvince String?
  street        String?
  postalCode    String?
  country       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("personal_info")
}

model Contact {
  id             String  @id @default(uuid())
  userId         String  @unique
  phoneNumber    String?
  secondaryEmail String?
  linkedinUrl    String?
  websiteUrl     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("contacts")
}

// ============================================
// COMPANY & JOBS DOMAIN
// ============================================

model Company {
  id          String  @id @default(uuid())
  accountId   String  @unique
  companyName String
  industry    String?
  location    String?
  website     String?
  description String? @db.Text
  logoUrl     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teams Team[]
  jobs  Job[]

  @@map("companies")
}

model Team {
  id          String  @id @default(uuid())
  companyId   String
  teamName    String
  description String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  members User[]

  @@map("teams")
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  FREELANCE
}

enum JobStatus {
  DRAFT
  OPEN
  CLOSED
  ON_HOLD
}

model Job {
  id           String  @id @default(uuid())
  companyId    String
  recruiterId  String
  title        String
  description  String  @db.Text
  jobType      JobType
  location     String?
  remoteOption Boolean @default(false)

  // Experience & Education
  minExperienceYears     Int?
  maxExperienceYears     Int?
  educationLevelRequired String?

  // Skills & Requirements
  requiredSkills  Json? // Array of required skills
  preferredSkills Json? // Array of preferred skills
  requirements    Json? // Structured requirements for AI

  // Compensation
  salaryMin      Decimal? @db.Decimal(12, 2)
  salaryMax      Decimal? @db.Decimal(12, 2)
  salaryCurrency String?  @default("USD")

  // Status & Dates
  status    JobStatus @default(DRAFT)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closesAt  DateTime?

  // Relations
  company      Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  recruiter    User             @relation(fields: [recruiterId], references: [id])
  applications JobApplication[]
  interviews   Interview[]
  rankings     ResumeRanking[]

  @@index([companyId])
  @@index([recruiterId])
  @@index([status])
  @@map("jobs")
}

// ============================================
// JOB APPLICATIONS
// ============================================

enum ApplicationStatus {
  APPLIED
  UNDER_REVIEW
  INTERVIEW_SCHEDULED
  INTERVIEWED
  OFFER_EXTENDED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

model JobApplication {
  id       String @id @default(uuid())
  jobId    String
  userId   String
  resumeId String

  status       ApplicationStatus @default(APPLIED)
  rankingScore Decimal?          @db.Decimal(5, 2) // AI-generated match score 0-100
  coverLetter  String?           @db.Text

  appliedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  job    Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  resume Resume @relation(fields: [resumeId], references: [id])

  interviews    Interview[]
  aiEvaluations AIEvaluation[]

  @@unique([jobId, userId]) // User can only apply once per job
  @@index([userId])
  @@index([jobId])
  @@index([status])
  @@map("job_applications")
}

// ============================================
// RESUME DOMAIN
// ============================================

model Resume {
  id       String  @id @default(uuid())
  userId   String
  title    String // e.g., "Senior Software Engineer Resume"
  fileName String
  filePath String
  fileSize Int?
  mimeType String?

  // Parsing status
  isParsed Boolean   @default(false)
  parsedAt DateTime?

  uploadedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  skills         ResumeSkill[]
  experiences    ResumeExperience[]
  educations     ResumeEducation[]
  certifications ResumeCertification[]
  applications   JobApplication[]
  rankings       ResumeRanking[]

  @@index([userId])
  @@map("resumes")
}

model ResumeSkill {
  id               String  @id @default(uuid())
  resumeId         String
  skillName        String
  proficiencyLevel String? // Beginner, Intermediate, Advanced, Expert
  yearsExperience  Int?

  createdAt DateTime @default(now())

  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
  @@map("resume_skills")
}

model ResumeExperience {
  id            String    @id @default(uuid())
  resumeId      String
  companyName   String
  positionTitle String
  startDate     DateTime
  endDate       DateTime?
  isCurrent     Boolean   @default(false)
  description   String?   @db.Text
  location      String?

  createdAt DateTime @default(now())

  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
  @@map("resume_experiences")
}

model ResumeEducation {
  id              String    @id @default(uuid())
  resumeId        String
  institutionName String
  degree          String
  fieldOfStudy    String?
  graduationDate  DateTime?
  gpa             Decimal?  @db.Decimal(3, 2)
  location        String?

  createdAt DateTime @default(now())

  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
  @@map("resume_educations")
}

model ResumeCertification {
  id                  String    @id @default(uuid())
  resumeId            String
  certificationName   String
  issuingOrganization String
  issueDate           DateTime?
  expirationDate      DateTime?
  credentialId        String?
  credentialUrl       String?

  createdAt DateTime @default(now())

  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
  @@map("resume_certifications")
}

model ResumeRanking {
  id       String @id @default(uuid())
  jobId    String
  resumeId String
  userId   String

  matchingScore             Decimal  @db.Decimal(5, 2) // 0-100
  skillsMatchPercentage     Decimal? @db.Decimal(5, 2)
  experienceMatchPercentage Decimal? @db.Decimal(5, 2)
  educationMatchPercentage  Decimal? @db.Decimal(5, 2)
  rankingPosition           Int? // 1, 2, 3, etc.

  generatedAt DateTime @default(now())

  job    Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@unique([jobId, resumeId])
  @@index([jobId])
  @@index([resumeId])
  @@map("resume_rankings")
}

// ============================================
// INTERVIEW DOMAIN
// ============================================

enum InterviewType {
  AI_VIDEO
  MANUAL_VIDEO
  PHONE
  IN_PERSON
}

enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Interview {
  id            String @id @default(uuid())
  applicationId String
  userId        String
  jobId         String

  interviewType   InterviewType   @default(AI_VIDEO)
  interviewStatus InterviewStatus @default(SCHEDULED)

  // Recording & Transcription
  recordingUrl      String? // Video file path/URL
  transcriptionText String? @db.Text

  // Timestamps
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  application JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id])
  job         Job            @relation(fields: [jobId], references: [id])

  questions     Question[]
  responses     Response[]
  summary       InterviewSummary?
  aiEvaluations AIEvaluation[]

  @@index([applicationId])
  @@index([userId])
  @@index([jobId])
  @@index([interviewStatus])
  @@map("interviews")
}

enum QuestionType {
  TECHNICAL
  BEHAVIORAL
  SITUATIONAL
  GENERAL
}

model Question {
  id            String       @id @default(uuid())
  interviewId   String
  questionText  String       @db.Text
  questionOrder Int // 1, 2, 3
  questionType  QuestionType @default(GENERAL)
  isAiGenerated Boolean      @default(false)

  createdAt DateTime @default(now())

  interview Interview  @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  responses Response[]

  @@index([interviewId])
  @@map("questions")
}

model Response {
  id          String @id @default(uuid())
  questionId  String
  userId      String
  interviewId String

  responseText            String? @db.Text // Transcribed text
  responseAudioUrl        String? // Audio file URL
  responseDurationSeconds Int?

  createdAt DateTime @default(now())

  question  Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])
  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@index([interviewId])
  @@map("responses")
}

model InterviewSummary {
  id          String @id @default(uuid())
  interviewId String @unique

  overallSummary String @db.Text
  strengths      Json? // Array of strengths
  weaknesses     Json? // Array of weaknesses
  keyInsights    Json? // Array of insights

  createdAt DateTime @default(now())

  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@map("interview_summaries")
}

// ============================================
// AI EVALUATION DOMAIN
// ============================================

enum RecommendationType {
  STRONGLY_RECOMMEND
  RECOMMEND
  NEUTRAL
  NOT_RECOMMEND
  STRONGLY_NOT_RECOMMEND
}

model AIEvaluation {
  id            String  @id @default(uuid())
  applicationId String
  interviewId   String?

  // Scores (0-100)
  overallScore              Decimal  @db.Decimal(5, 2)
  resumeMatchScore          Decimal  @db.Decimal(5, 2)
  interviewPerformanceScore Decimal? @db.Decimal(5, 2)
  skillsAssessmentScore     Decimal? @db.Decimal(5, 2)

  // Recommendation
  recommendation RecommendationType

  // Detailed Analysis
  strengths        Json? // Array of strengths
  weaknesses       Json? // Array of weaknesses
  detailedFeedback String? @db.Text

  // AI Model Info
  modelUsed    String? // e.g., "gpt-4", "claude-3"
  modelVersion String?

  createdAt DateTime @default(now())

  application JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  interview   Interview?     @relation(fields: [interviewId], references: [id], onDelete: SetNull)

  @@index([applicationId])
  @@index([interviewId])
  @@map("ai_evaluations")
}

// ============================================
// NOTIFICATIONS (Optional but Recommended)
// ============================================

enum NotificationType {
  APPLICATION_STATUS
  INTERVIEW_INVITATION
  INTERVIEW_REMINDER
  INTERVIEW_RESULT
  NEW_JOB_MATCH
  MESSAGE
  SYSTEM
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

model Notification {
  id        String             @id @default(uuid())
  userId    String
  type      NotificationType
  status    NotificationStatus @default(UNREAD)
  title     String
  message   String             @db.Text
  actionUrl String?
  metadata  Json? // Additional data

  createdAt DateTime  @default(now())
  readAt    DateTime?

  @@index([userId])
  @@index([status])
  @@map("notifications")
}

// ============================================
// AUDIT LOG (Optional for Compliance)
// ============================================

model AuditLog {
  id         String  @id @default(uuid())
  userId     String?
  action     String // CREATE, UPDATE, DELETE, LOGIN, etc.
  entityType String // Job, User, Application, etc.
  entityId   String?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}
